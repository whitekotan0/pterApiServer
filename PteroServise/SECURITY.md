# Безпека та надійність системи

## Реалізовані покращення безпеки

### 1. Захист заголовків (Helmet)
- ✅ Додано `helmet` middleware для захисту від XSS, clickjacking та інших атак
- ✅ Налаштовано для API (вимкнено CSP для API endpoints)

### 2. Rate Limiting
- ✅ Глобальний rate limiting: 100 запитів на 15 хвилин з одного IP
- ✅ Строгий rate limiting для auth endpoints: 20 спроб на 15 хвилин
- ✅ Rate limiting для GPT endpoints: 50 запитів на 15 хвилин
- ✅ Автоматичне пропускання успішних запитів для auth

### 3. CORS налаштування
- ✅ Налаштовано CORS тільки для дозволених доменів
- ✅ Конфігурується через змінну оточення `ALLOWED_ORIGINS`
- ✅ За замовчуванням тільки localhost для розробки

### 4. Валідація вхідних даних
- ✅ Обмеження розміру тіла запиту (10MB для gateway, 1MB для auth, 5MB для GPT)
- ✅ Валідація через Zod для всіх endpoints
- ✅ Перевірка наявності обов'язкових полів
- ✅ Обмеження довжини Mermaid діаграм (макс 10000 символів)

### 5. JWT безпека
- ✅ Перевірка наявності JWT_SECRET при старті
- ✅ Попередження про використання дефолтного ключа
- ✅ Блокування запуску в продакшені без встановленого JWT_SECRET
- ✅ Детальна обробка помилок JWT (expired, invalid)

### 6. Обробка помилок
- ✅ Детальна обробка помилок OpenAI API
- ✅ Retry логіка з exponential backoff для OpenAI
- ✅ Timeout для всіх зовнішніх запитів
- ✅ Приховування деталей помилок в продакшені

### 7. Docker безпека
- ✅ Порти сервісів не експортуються публічно (тільки через gateway)
- ✅ Health checks для всіх контейнерів
- ✅ Обмеження ресурсів (CPU, пам'ять)
- ✅ Graceful shutdown для всіх сервісів

## Реалізовані покращення надійності

### 1. Retry логіка
- ✅ Exponential backoff для OpenAI API
- ✅ Автоматичний retry для помилок сервера (5xx)
- ✅ Без retry для помилок клієнта (4xx)

### 2. Timeout налаштування
- ✅ 30 секунд timeout для auth service
- ✅ 120 секунд timeout для GPT service (через довгі запити)
- ✅ 60 секунд timeout для OpenAI API

### 3. Health Checks
- ✅ Health check endpoints для всіх сервісів
- ✅ Docker health checks з автоматичним перезапуском
- ✅ Перевірка залежностей в health checks

### 4. Graceful Shutdown
- ✅ Обробка SIGTERM та SIGINT сигналів
- ✅ Коректне закриття HTTP серверів
- ✅ Завершення активних запитів перед виходом

### 5. Логування
- ✅ Структуроване логування помилок
- ✅ Логування запитів в dev режимі
- ✅ Приховування чутливих даних в логах

## Рекомендації для продакшену

### Обов'язкові налаштування

1. **JWT_SECRET**
   - Мінімум 64 символи
   - Випадковий рядок (не використовуйте слова)
   - Згенеруйте через: `node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"`

2. **HTTPS**
   - Обов'язково використовуйте HTTPS в продакшені
   - Використайте Let's Encrypt для безкоштовних сертифікатів
   - Налаштуйте Nginx як reverse proxy

3. **Firewall**
   - Закрийте всі порти крім 22 (SSH), 80 (HTTP), 443 (HTTPS)
   - НЕ відкривайте порти 3000, 3001, 3002 публічно
   - Доступ до сервісів тільки через API Gateway або Nginx

4. **CORS**
   - Налаштуйте `ALLOWED_ORIGINS` тільки для ваших доменів
   - Не використовуйте `*` в продакшені

5. **Environment Variables**
   - Ніколи не комітьте `.env` файл
   - Використовуйте секрети для чутливих даних
   - Регулярно ротуйте ключі

### Додаткові рекомендації

1. **Моніторинг**
   - Налаштуйте моніторинг (Prometheus, Grafana)
   - Налаштуйте алерти для критичних помилок
   - Відстежуйте використання ресурсів

2. **Backup**
   - Регулярно робіть backup конфігурацій
   - Backup `.env` файлу (в зашифрованому вигляді)
   - Backup Docker volumes (якщо використовуєте БД)

3. **Оновлення**
   - Регулярно оновлюйте залежності (`npm audit`)
   - Оновлюйте Docker образи
   - Оновлюйте систему сервера

4. **Логування**
   - Налаштуйте централізоване логування (ELK, Loki)
   - Зберігайте логи мінімум 30 днів
   - Не логуйте чутливі дані (токени, паролі)

5. **Тестування**
   - Регулярно тестуйте систему
   - Проводьте навантажувальне тестування
   - Тестуйте відновлення після збоїв

## Відомі обмеження

1. **In-memory storage**
   - Токени користувачів зберігаються в пам'яті
   - Дані втрачаються при перезапуску
   - Рекомендується додати базу даних

2. **Rate limiting**
   - Rate limiting базується на IP адресі
   - Може бути обійдено через проксі/VPN
   - Рекомендується додати rate limiting на рівні користувача

3. **Моніторинг**
   - Немає вбудованого моніторингу
   - Рекомендується додати Prometheus/Grafana

4. **База даних**
   - Немає персистентного зберігання
   - Рекомендується додати PostgreSQL/MongoDB

## Чеклист безпеки перед деплоєм

- [ ] JWT_SECRET встановлено та не є дефолтним значенням
- [ ] Всі змінні оточення налаштовані
- [ ] HTTPS налаштовано
- [ ] Firewall налаштовано
- [ ] CORS налаштовано тільки для ваших доменів
- [ ] `.env` файл НЕ закомічений в Git
- [ ] Nginx налаштовано як reverse proxy
- [ ] Health checks працюють
- [ ] Логування налаштовано
- [ ] Backup стратегія налаштована
- [ ] Моніторинг налаштовано (опціонально)
- [ ] Тестування пройдено успішно

## Контакти для звітування вразливостей

Якщо ви знайшли вразливість, будь ласка:
1. НЕ публікуйте її публічно
2. Створіть приватний issue або надішліть email
3. Надайте детальний опис та steps to reproduce
