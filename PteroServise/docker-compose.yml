version: '3.8'

services:
  # Фронтенд (статичний сайт)
  web-auth:
    build:
      context: ./web-auth
      dockerfile: Dockerfile
    container_name: web-auth
    ports:
      - "8080:80"
    networks:
      - pteroservise-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 5s
      retries: 3

  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    ports:
      - "3000:3000"
    env_file:
      - .env
    environment:
      - PORT=3000
      - NODE_ENV=${NODE_ENV:-production}
      - AUTH_SERVICE_URL=http://auth-service:3001
      - GPT_SERVICE_URL=http://gpt-service:3002
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:3000}
    depends_on:
      auth-service:
        condition: service_healthy
      gpt-service:
        condition: service_healthy
    networks:
      - pteroservise-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    # Порти не експортуємо публічно - доступ тільки через gateway
    expose:
      - "3001"
    env_file:
      - .env
    environment:
      - PORT=3001
      - NODE_ENV=${NODE_ENV:-production}
      # JWT налаштування
      - JWT_SECRET=${JWT_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET:-}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-15m}
      - JWT_REFRESH_EXPIRES_IN=${JWT_REFRESH_EXPIRES_IN:-30d}
      - JWT_ISSUER=${JWT_ISSUER:-pteroservise}
      - JWT_AUDIENCE=${JWT_AUDIENCE:-mineai-desktop}
      # Firebase налаштування
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - FIREBASE_PRIVATE_KEY=${FIREBASE_PRIVATE_KEY}
      - FIREBASE_CLIENT_EMAIL=${FIREBASE_CLIENT_EMAIL}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:3000}
    networks:
      - pteroservise-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  gpt-service:
    build:
      context: ./services/gpt-service
      dockerfile: Dockerfile
    container_name: gpt-service
    # Порти не експортуємо публічно - доступ тільки через gateway
    expose:
      - "3002"
    env_file:
      - .env
    environment:
      - PORT=3002
      - NODE_ENV=${NODE_ENV:-production}
      # JWT налаштування (для верифікації токенів)
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ISSUER=${JWT_ISSUER:-pteroservise}
      - JWT_AUDIENCE=${JWT_AUDIENCE:-mineai-desktop}
      # OpenAI налаштування
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:3000}
    networks:
      - pteroservise-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3002/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '1.0'
          memory: 512M

networks:
  pteroservise-network:
    driver: bridge
